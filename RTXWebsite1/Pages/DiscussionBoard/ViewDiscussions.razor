@page "/viewdiscussions"

@using RTXWebsite1.IDbContext
@using RTXWebsite1.Models
@using Microsoft.Extensions.Configuration
@inject IDiscussionBoardAccess _discussion
@inject IConfiguration _config
@inject NavigationManager NavManager
@inject RTXWebsite1.Data.Utils util


<div class="my_headers">
    <h1>Discussion Board for all Classes</h1>
</div>

<hr />

<h3>View Discussions</h3>
<button class="btn btn-primary" @onclick="NewDiscussion">Post New Discussion</button>
@if (discussions == null)
{
    <p><em>Loading...</em></p>
}
else
{
    @foreach (var p in discussions)
    {
        if(p.Type == "Original")
        {
            <p>
             Written by @p.PlayerName at @p.Date 
             
            </p>
            <p>
                 <a href="marketplace" @onclick="(() => Reply(p))"> @p.DiscussionName</a>
            </p>

            <p>
                @p.DiscussionContent
            </p>
            <p>
            -----------------------------------------------
            </p>
        <button class="btn btn-primary" @onclick="(() => Reply(p))">Reply</button>
        <button class="btn btn-primary" @onclick="(() => DeleteDiscussion(p))">DELETE</button>
        }

    }
}

@code {
    List<DiscussionBoard>? discussions;
    List<DiscussionBoard>? deletedDiscussion;

    public async Task Reply(DiscussionBoard discussionBoard)
    {
        //**** special edge case ****//
        // if the param passed has a question mark then it glitches
        // so store the name temporarily until we get to the reply screen

        util.paramDiscussionName = discussionBoard.DiscussionName;

        util.AnchorId = discussionBoard.Id;
        NavManager.NavigateTo($"/replytodiscussion/{discussionBoard.DiscussionName}");

    }


    public async Task NewDiscussion()
    {
        NavManager.NavigateTo("/newdiscussion");
    }


    private async Task GetData()
    {
        await OnInitializedAsync();
    }


    protected override async Task OnInitializedAsync()
    {
        string sql = "select * from discussion";

        discussions = await _discussion.LoadData<DiscussionBoard, dynamic>(sql, new { }, _config.GetConnectionString("Discussion"));
    }


    public async Task DeleteDiscussion(DiscussionBoard discussionBoard)
    {
        string sql = "delete from discussion where DiscussionName = @DiscussionName";

        deletedDiscussion = await _discussion.DeleteData<DiscussionBoard, dynamic>(sql, new { DiscussionName = discussionBoard.DiscussionName}, _config.GetConnectionString("Discussion"));
         NavManager.NavigateTo("/viewdiscussions", forceLoad: true);
    }
}
